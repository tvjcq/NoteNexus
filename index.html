<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="style.css" />
    <title>Note Nexus</title>
  </head>
  <body>
    <header>
      <div>
        <img src="https://via.placeholder.com/100" alt="Profile Picture" />
        <h1>Bienvenue Bobby</h1>
      </div>
      <div>
        <p>Découvrez vous musicalement</p>
        <i class="bi bi-arrow-down"></i>
      </div>
    </header>
    <div class="container">
      <div class="row" id="cardGrid"></div>
    </div>

    <div
      class="modal fade"
      id="noPreviewModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="noPreviewModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="noPreviewModalLabel">
              Housten, nous avons un problème
            </h5>
          </div>
          <div class="modal-body">
            Désolé, mais il n'y a pas de preview pour ce son.
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              id="closeModalBtn"
              data-dismiss="modal"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      var currentAudio = null;

      function playAudio(url, i) {
        if (url == null) {
          var modal = document.getElementById("noPreviewModal");
          modal.classList.add("show");
          modal.style.display = "block";
          return;
        }
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          if (playurl == url) {
            document
              .getElementById(`play-icon-${i}`)
              .classList.remove("bi-pause-fill");
            document
              .getElementById(`play-icon-${i}`)
              .classList.add("bi-play-fill");
            playurl = null;
            return;
          }
        }
        const previousIcon = document.querySelector(".bi-pause-fill");
        if (previousIcon) {
          previousIcon.classList.remove("bi-pause-fill");
          previousIcon.classList.add("bi-play-fill");
        }
        playurl = url;

        document
          .getElementById(`play-icon-${i}`)
          .classList.remove("bi-play-fill");
        document
          .getElementById(`play-icon-${i}`)
          .classList.add("bi-pause-fill");

        currentAudio = new Audio(url);
        currentAudio.play();
      }

      function closeModal() {
        var modal = document.getElementById("noPreviewModal");
        modal.classList.remove("show");
        modal.style.display = "none";
      }

      function msToMinSec(ms) {
        let minutes = Math.floor(ms / 60000);
        let seconds = ((ms % 60000) / 1000).toFixed(0);
        return minutes + "min " + (seconds < 10 ? "0" : "") + seconds + "s";
      }

      fetch("data.json")
        .then((response) => response.json())
        .then((jsonData) => {
          var cardGrid = document.getElementById("cardGrid");
          var i = 0;
          jsonData.forEach(function (cardData, i) {
            i++;
            const durationInMs = `${cardData.duration_ms}`;
            const durationInMinSec = msToMinSec(durationInMs);
            var card = document.createElement("div");
            card.classList.add("col-md-4", "col-sm-6", "my-3");

            var cardHtml = `
                <div class="card">
                  <div class="imgPlayer">
                    <img src="${
                      cardData.album.images[0].url
                    }" class="card-img-top" alt="Card Image">
                    <div class="playButton" >
                      <i id="play-icon-${i}"  class="bi bi-play-fill"></i>
                    </div>
                  </div>
                  <div class="card-body">
                    <h4 class="card-title"><b>${i}.</b> ${cardData.name}</h4>
                    <p class="card-text mb-0">
                      ${cardData.artists
                        .map((artist) => artist.name)
                        .join(", ")}
                    </p>
                    <p class="card-text">
                      <small class="text-muted">${cardData.album.name}</small>
                    </p>
                    <button id="moreInfo-${i}" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-${i}"">
                      Plus d'infos
                    </button>
                  </div>
                </div>

                <div class="modal fade" id="modal-${i}" tabindex="-1" aria-labelledby="modalLabel-${i}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalLabel-${i}">${
              cardData.name
            }</h5> </br>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <img src="${
                cardData.album.images[0].url
              }" class="card-img-top rounded" alt="Card Image">
              <p>Titre : ${cardData.name}</p>
              <p>Album : ${cardData.album.name}</p>
              <p>Date de sortie : ${new Date(
                cardData.album.release_date
              ).toLocaleDateString("fr-FR", {
                day: "numeric",
                month: "long",
                year: "numeric",
              })}</p>
              <p>Durée : ${durationInMinSec}</p>
              <p>Artiste(s) : ${cardData.artists
                .map((artist) => artist.name)
                .join(", ")}</p>
              <p>Followers : ${cardData.artists[0].followers.total.toLocaleString(
                undefined,
                { useGrouping: true }
              )}</p>

            </div>
            <div class="modal-footer">
              <button type="button" id="spotifyBtn-${i}" class="btn btn-primary">Écouter sur Spotify</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
          </div>
        </div>
      </div>
              `;

            card.innerHTML = cardHtml;
            cardGrid.appendChild(card);

            document
              .getElementById(`play-icon-${i}`)
              .addEventListener("click", function () {
                playAudio(cardData.preview_url, i);
              });

            document
              .getElementById(`spotifyBtn-${i}`)
              .addEventListener("click", function () {
                window.open(cardData.external_urls.spotify);
              });

            document
              .getElementById(`closeModalBtn`)
              .addEventListener("click", function () {
                closeModal();
              });
          });
        })
        .catch((error) => {
          console.error("Error fetching JSON data:", error);
        });
    </script>
  </body>
</html>
